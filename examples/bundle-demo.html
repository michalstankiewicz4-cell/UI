<!DOCTYPE html>
<html><head><meta charset="UTF-8"><title>UI - DEBUG</title>
<style>body{margin:0;overflow:hidden;background:#1a1a1a;font-family:'Courier New'}canvas{display:block;cursor:default}</style>
</head><body><canvas id="canvas"></canvas><script src="../dist/ui.js"></script><script>
// PATCH handleMouseUp - DEBUG VERSION
UI.WindowManager.prototype.handleMouseUp = function(x, y) {
    console.log('>>> handleMouseUp called:', {
        hasActiveWindow: !!this.activeWindow,
        activeWindow: this.activeWindow?.title,
        actuallyDragged: this.actuallyDragged,
        x, y
    });
    
    if (this.activeWindow) {
        if (!this.actuallyDragged) {
            console.log('>>> CALLING handleClick on', this.activeWindow.title);
            const result = this.activeWindow.handleClick(x, y);
            console.log('>>> handleClick returned:', result);
        }
        this.activeWindow.stopDrag();
        this.activeWindow = null;
    } else {
        console.log('>>> NO activeWindow!');
    }
};

UI.WindowManager.prototype.handleMouseDown = function(x, y) {
    this.mouseDownX = x;
    this.mouseDownY = y;
    this.actuallyDragged = false;
    
    for (let i = this.windows.length - 1; i >= 0; i--) {
        const window = this.windows[i];
        if (window.startDrag(x, y)) {
            this.activeWindow = window;
            this.bringToFront(window);
            console.log('>>> activeWindow set to:', window.title);
            return true;
        }
    }
    return false;
};

UI.WindowManager.prototype.handleMouseMove = function(x, y) {
    if (this.activeWindow && this.activeWindow.isDragging) {
        const dx = Math.abs(x - (this.mouseDownX || x));
        const dy = Math.abs(y - (this.mouseDownY || y));
        if (dx > 3 || dy > 3) this.actuallyDragged = true;
        this.activeWindow.drag(x, y);
    }
};

UI.BaseWindow.prototype.drawButton = function(ctx, STYLES, item, y) {
    ctx.fillStyle = 'rgba(0, 255, 136, 0.2)';
    ctx.fillRect(this.x + this.padding, y, this.width - this.padding * 2, 20);
    ctx.strokeStyle = STYLES.colors.panel;
    ctx.lineWidth = 2;
    ctx.strokeRect(this.x + this.padding, y, this.width - this.padding * 2, 20);
    ctx.fillStyle = STYLES.colors.panel;
    ctx.font = STYLES.fonts.mainBold;
    ctx.textAlign = 'center';
    ctx.fillText(item.label, this.x + this.width / 2, y + 14);
    ctx.textAlign = 'left';
};

const canvas = document.getElementById('canvas');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;
const ctx = canvas.getContext('2d');

const windowManager = new UI.WindowManager();
const taskbar = new UI.Taskbar();

const w1 = new UI.BaseWindow(50, 50, 'Test');
w1.width = 300; w1.height = 200;
w1.addText('Kliknij button:', '#00FF88');
let clicks = 0;
w1.addButton('KLIKNIJ!', () => {
    clicks++;
    console.log('>>> BUTTON CALLBACK!', clicks);
    alert('DZIALA! ' + clicks);
});
windowManager.add(w1);

const eventRouter = new UI.EventRouter(canvas, null, windowManager, taskbar, null);

function render() {
    ctx.fillStyle = '#1a1a1a';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    w1.isDirty = true;
    w1.draw(ctx, UI.STYLES);
    requestAnimationFrame(render);
}
render();
console.log('READY! Click button and watch console!');
</script></body></html>
